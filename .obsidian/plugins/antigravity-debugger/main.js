/*
AntiGravity Debugger - Obsidian Plugin
Time-travel C++ visualization
*/
var w=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var N=(c,e)=>{for(var t in e)w(c,t,{get:e[t],enumerable:!0})},_=(c,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of D(e))!L.call(c,a)&&a!==t&&w(c,a,{get:()=>e[a],enumerable:!(i=O(e,a))||i.enumerable});return c};var R=c=>_(w({},"__esModule",{value:!0}),c);var B={};N(B,{default:()=>E});module.exports=R(B);var d=require("obsidian");var g=require("obsidian");var r={NODE_WIDTH:140,NODE_HEIGHT_BASE:50,NODE_HEIGHT_PER_MEMBER:22,NODE_PADDING:10,NODE_MARGIN:30,STACK_X:50,HEAP_X:300,START_Y:50,COLORS:{stackBg:"#3b82f6",stackBorder:"#2563eb",heapBg:"#10b981",heapBorder:"#059669",nullBg:"#ef4444",nullBorder:"#dc2626",text:"#ffffff",arrow:"#8b5cf6",arrowHead:"#8b5cf6"},ARROW_WIDTH:2,ARROW_HEAD_SIZE:8},v=class{constructor(e){this.svg=null;this.nodes=new Map;this.edges=[];this.container=e,this.initSVG()}initSVG(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("class","ag-svg"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%");let e=document.createElementNS("http://www.w3.org/2000/svg","defs");e.innerHTML=`
            <marker id="arrowhead" markerWidth="${r.ARROW_HEAD_SIZE}" markerHeight="${r.ARROW_HEAD_SIZE}" 
                    refX="${r.ARROW_HEAD_SIZE}" refY="${r.ARROW_HEAD_SIZE/2}" orient="auto">
                <polygon points="0 0, ${r.ARROW_HEAD_SIZE} ${r.ARROW_HEAD_SIZE/2}, 0 ${r.ARROW_HEAD_SIZE}" 
                         fill="${r.COLORS.arrowHead}" />
            </marker>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
            </filter>
        `,this.svg.appendChild(e),this.container.appendChild(this.svg)}renderFrame(e){if(!this.svg)return;let t=this.svg.querySelector("defs");this.svg.innerHTML="",t&&this.svg.appendChild(t),this.nodes.clear(),this.edges=[],this.layoutNodes(e),this.renderEdges(),this.renderNodes(),this.fitViewBox()}layoutNodes(e){let t=r.START_Y,i=r.START_Y;for(let a of e.stack_vars){let s=r.NODE_HEIGHT_BASE,n={id:`stack-${a.name}`,label:a.name,type:"stack",x:r.STACK_X,y:t,width:r.NODE_WIDTH,height:s,data:{value:a.value,type:a.type}};this.nodes.set(n.id,n),t+=s+r.NODE_MARGIN,a.type==="pointer"&&a.points_to&&this.edges.push({id:`edge-${a.name}`,from:n.id,to:a.points_to,label:a.name,isStackPointer:!0})}for(let a of e.heap_objects){let s=Object.keys(a.data).length+Object.keys(a.pointers).length,n=r.NODE_HEIGHT_BASE+s*r.NODE_HEIGHT_PER_MEMBER,l={id:a.id,label:a.label,type:"heap",x:r.HEAP_X,y:i,width:r.NODE_WIDTH,height:n,data:{...a.data}};this.nodes.set(l.id,l),i+=n+r.NODE_MARGIN;for(let[o,p]of Object.entries(a.pointers))this.edges.push({id:`edge-${a.id}-${o}`,from:a.id,to:p,label:o})}}renderNodes(){for(let t of this.nodes.values())this.renderNode(t);this.edges.filter(t=>t.to==="null").length>0&&this.renderNullSymbol()}renderNode(e){if(!this.svg)return;let t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("class",`ag-node ag-node-${e.type}`),t.setAttribute("transform",`translate(${e.x}, ${e.y})`);let i=e.type==="stack"?r.COLORS.stackBg:r.COLORS.heapBg,a=e.type==="stack"?r.COLORS.stackBorder:r.COLORS.heapBorder,s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("width",String(e.width)),s.setAttribute("height",String(e.height)),s.setAttribute("rx","8"),s.setAttribute("fill",i),s.setAttribute("stroke",a),s.setAttribute("stroke-width","2"),s.setAttribute("filter","url(#shadow)"),t.appendChild(s);let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",String(e.width/2)),n.setAttribute("y","20"),n.setAttribute("text-anchor","middle"),n.setAttribute("fill",r.COLORS.text),n.setAttribute("font-weight","bold"),n.setAttribute("font-size","14"),n.textContent=e.label,t.appendChild(n);let l=40;for(let[o,p]of Object.entries(e.data)){let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",String(r.NODE_PADDING)),h.setAttribute("y",String(l)),h.setAttribute("fill",r.COLORS.text),h.setAttribute("font-size","12"),h.setAttribute("font-family","monospace"),h.textContent=`${o}: ${this.truncate(p,12)}`,t.appendChild(h),l+=r.NODE_HEIGHT_PER_MEMBER}if(e.type==="heap"){let o=document.createElementNS("http://www.w3.org/2000/svg","text");o.setAttribute("x",String(e.width-r.NODE_PADDING)),o.setAttribute("y",String(e.height-6)),o.setAttribute("text-anchor","end"),o.setAttribute("fill","rgba(255,255,255,0.6)"),o.setAttribute("font-size","10"),o.setAttribute("font-family","monospace"),o.textContent=e.id,t.appendChild(o)}this.svg.appendChild(t)}renderNullSymbol(){if(!this.svg)return;let e=r.HEAP_X+r.NODE_WIDTH+100,t=r.START_Y+50;for(let s of this.nodes.values())s.type==="heap"&&(e=Math.max(e,s.x+s.width+80));let i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("transform",`translate(${e}, ${t})`);let a=document.createElementNS("http://www.w3.org/2000/svg","g");a.innerHTML=`
            <line x1="0" y1="0" x2="0" y2="15" stroke="${r.COLORS.nullBorder}" stroke-width="3"/>
            <line x1="-15" y1="15" x2="15" y2="15" stroke="${r.COLORS.nullBorder}" stroke-width="3"/>
            <line x1="-10" y1="22" x2="10" y2="22" stroke="${r.COLORS.nullBorder}" stroke-width="2"/>
            <line x1="-5" y1="29" x2="5" y2="29" stroke="${r.COLORS.nullBorder}" stroke-width="2"/>
            <text x="0" y="50" text-anchor="middle" fill="${r.COLORS.nullBorder}" font-weight="bold" font-size="12">NULL</text>
        `,i.appendChild(a),this.nodes.set("null",{id:"null",label:"NULL",type:"heap",x:e,y:t,width:30,height:50,data:{}}),this.svg.appendChild(i)}renderEdges(){if(this.svg)for(let e of this.edges)this.renderEdge(e)}renderEdge(e){if(!this.svg)return;let t=this.nodes.get(e.from),i=this.nodes.get(e.to);if(!t)return;let a=t.x+t.width,s=t.y+t.height/2,n,l;i?(n=i.x,l=i.y+i.height/2):(n=a+50,l=s);let o=n-a,p=a+o*.5,h=document.createElementNS("http://www.w3.org/2000/svg","path"),A=`M ${a} ${s} C ${p} ${s}, ${p} ${l}, ${n-r.ARROW_HEAD_SIZE} ${l}`;if(h.setAttribute("d",A),h.setAttribute("fill","none"),h.setAttribute("stroke",r.COLORS.arrow),h.setAttribute("stroke-width",String(r.ARROW_WIDTH)),h.setAttribute("marker-end","url(#arrowhead)"),h.setAttribute("class","ag-edge"),e.isStackPointer&&h.setAttribute("stroke-dasharray","5,3"),this.svg.appendChild(h),e.label){let C=a+o*.5,T=(s+l)/2-10,u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",String(C)),u.setAttribute("y",String(T)),u.setAttribute("text-anchor","middle"),u.setAttribute("fill",r.COLORS.arrow),u.setAttribute("font-size","11"),u.setAttribute("font-weight","bold"),u.textContent=e.label,this.svg.appendChild(u)}}fitViewBox(){if(!this.svg)return;let e=0,t=0;for(let i of this.nodes.values())e=Math.max(e,i.x+i.width+50),t=Math.max(t,i.y+i.height+50);this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`)}truncate(e,t){return e.length<=t?e:e.substring(0,t-2)+"\u2026"}destroy(){this.svg&&(this.svg.remove(),this.svg=null)}};var f=class{constructor(e,t,i=500){this.slider=null;this.playBtn=null;this.frameLabel=null;this.totalFrames=0;this.currentFrame=0;this.isPlaying=!1;this.playInterval=null;this.container=e,this.onFrameChange=t,this.playSpeed=i,this.buildUI()}buildUI(){this.container.addClass("ag-time-travel");let e=this.createButton("\u23EE","First Frame",()=>this.goToFrame(0)),t=this.createButton("\u25C0","Previous Frame",()=>this.stepBackward());this.playBtn=this.createButton("\u25B6","Play",()=>this.togglePlay()),this.playBtn.addClass("ag-btn-play");let i=this.createButton("\u25B6","Next Frame",()=>this.stepForward()),a=this.createButton("\u23ED","Last Frame",()=>this.goToFrame(this.totalFrames-1)),s=this.container.createDiv({cls:"ag-slider-container"});this.frameLabel=s.createEl("span",{cls:"ag-frame-label"}),this.frameLabel.textContent="Frame 0/0",this.slider=s.createEl("input",{cls:"ag-slider",attr:{type:"range",min:"0",max:"0",value:"0"}}),this.slider.addEventListener("input",()=>{if(this.slider){let o=parseInt(this.slider.value,10);this.goToFrame(o)}});let n=this.container.createDiv({cls:"ag-speed-container"});n.createEl("span",{text:"Speed:"});let l=n.createEl("input",{cls:"ag-speed-slider",attr:{type:"range",min:"100",max:"2000",value:String(this.playSpeed)}});l.addEventListener("input",()=>{this.playSpeed=parseInt(l.value,10)})}createButton(e,t,i){let a=this.container.createEl("button",{cls:"ag-btn ag-btn-control",text:e,attr:{title:t}});return a.addEventListener("click",i),a}setTotalFrames(e){this.totalFrames=e,this.slider&&(this.slider.max=String(Math.max(0,e-1))),this.updateLabel()}setCurrentFrame(e){this.currentFrame=Math.max(0,Math.min(e,this.totalFrames-1)),this.slider&&(this.slider.value=String(this.currentFrame)),this.updateLabel()}goToFrame(e){e<0||e>=this.totalFrames||(this.currentFrame=e,this.setCurrentFrame(e),this.onFrameChange(e))}stepForward(){this.currentFrame<this.totalFrames-1?this.goToFrame(this.currentFrame+1):this.stopPlay()}stepBackward(){this.currentFrame>0&&this.goToFrame(this.currentFrame-1)}togglePlay(){this.isPlaying?this.stopPlay():this.startPlay()}startPlay(){this.isPlaying||(this.isPlaying=!0,this.playBtn&&(this.playBtn.textContent="\u23F8",this.playBtn.title="Pause"),this.playInterval=setInterval(()=>{this.stepForward()},this.playSpeed))}stopPlay(){this.isPlaying&&(this.isPlaying=!1,this.playBtn&&(this.playBtn.textContent="\u25B6",this.playBtn.title="Play"),this.playInterval&&(clearInterval(this.playInterval),this.playInterval=null))}updateLabel(){this.frameLabel&&(this.frameLabel.textContent=`Frame ${this.currentFrame+1}/${this.totalFrames}`)}destroy(){this.stopPlay(),this.container.empty()}};var y=class{constructor(e){this.baseUrl=e.replace(/\/$/,"")}async trace(e,t={}){let i={source_code:e,filename:t.filename||"main.cpp",max_steps:t.maxSteps||500},a=await fetch(`${this.baseUrl}/trace`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok){let s=await a.json().catch(()=>({}));throw new Error(s.detail||`HTTP ${a.status}: ${a.statusText}`)}return await a.json()}async health(){try{return(await fetch(`${this.baseUrl}/health`)).ok}catch(e){return!1}}setBaseUrl(e){this.baseUrl=e.replace(/\/$/,"")}};var m="antigravity-debugger-view",b=class extends g.ItemView{constructor(t,i){super(t);this.container=null;this.codeEditor=null;this.visualizationContainer=null;this.controlsContainer=null;this.statusBar=null;this.visualizer=null;this.timeTravel=null;this.apiClient=null;this.trace=null;this.currentFrameIndex=0;this.isLoading=!1;this.plugin=i}getViewType(){return m}getDisplayText(){return"AntiGravity Debugger"}getIcon(){return"bug"}async onOpen(){this.apiClient=new y(this.plugin.settings.apiUrl),this.buildUI(),this.visualizationContainer&&(this.visualizer=new v(this.visualizationContainer)),this.controlsContainer&&(this.timeTravel=new f(this.controlsContainer,t=>this.onFrameChange(t),this.plugin.settings.playSpeed))}async onClose(){var t,i;(t=this.visualizer)==null||t.destroy(),(i=this.timeTravel)==null||i.destroy()}buildUI(){let{contentEl:t}=this;t.empty(),t.addClass("antigravity-debugger"),this.container=t.createDiv({cls:"ag-container"});let i=this.container.createDiv({cls:"ag-panel ag-code-panel"});this.buildCodeEditor(i);let a=this.container.createDiv({cls:"ag-panel ag-viz-panel"});this.buildVisualization(a),this.controlsContainer=t.createDiv({cls:"ag-controls"}),this.statusBar=t.createDiv({cls:"ag-status"}),this.updateStatus('Ready. Enter C++ code and click "Trace".')}buildCodeEditor(t){let i=t.createDiv({cls:"ag-header"});i.createEl("h3",{text:"\u{1F4DD} C++ Code"}),i.createEl("button",{cls:"ag-btn ag-btn-primary",text:"\u25B6 Trace"}).addEventListener("click",()=>this.runTrace()),this.codeEditor=t.createEl("textarea",{cls:"ag-code-editor",attr:{placeholder:`// Paste your C++ code here...
#include <iostream>

int main() {
    // ...
    return 0;
}`,spellcheck:"false"}}),this.codeEditor.value=this.getSampleCode()}buildVisualization(t){let i=t.createDiv({cls:"ag-header"});i.createEl("h3",{text:"\u{1F50D} Memory Visualization"});let a=i.createDiv({cls:"ag-frame-info"});a.id="ag-frame-info",this.visualizationContainer=t.createDiv({cls:"ag-visualization"})}getSampleCode(){return`#include <iostream>

struct Node {
    int data;
    Node* next;
    Node(int val) : data(val), next(nullptr) {}
};

int main() {
    // Create linked list: 10 -> 20 -> 30 -> NULL
    Node* head = new Node(10);
    head->next = new Node(20);
    head->next->next = new Node(30);
    
    // Traverse and print
    Node* current = head;
    while (current != nullptr) {
        std::cout << current->data << " ";
        current = current->next;
    }
    
    // Cleanup
    while (head != nullptr) {
        Node* temp = head;
        head = head->next;
        delete temp;
    }
    
    return 0;
}`}loadSourceCode(t){this.codeEditor&&(this.codeEditor.value=t)}async runTrace(){var i,a;if(!this.codeEditor||!this.apiClient)return;let t=this.codeEditor.value.trim();if(!t){new g.Notice("Please enter some C++ code first.");return}this.isLoading=!0,this.updateStatus("\u23F3 Compiling and tracing...");try{let s=await this.apiClient.trace(t,{maxSteps:this.plugin.settings.maxSteps});if(s.success&&s.trace)this.trace=s.trace,this.currentFrameIndex=0,(i=this.timeTravel)==null||i.setTotalFrames(this.trace.frames.length),(a=this.timeTravel)==null||a.setCurrentFrame(0),this.renderFrame(0),this.updateStatus(`\u2705 Traced ${this.trace.frames.length} frames. Use slider to navigate.`),new g.Notice(`Trace complete: ${this.trace.frames.length} frames`);else throw new Error(s.message||"Unknown error")}catch(s){console.error("Trace failed:",s),this.updateStatus(`\u274C Error: ${s}`),new g.Notice(`Trace failed: ${s}`)}finally{this.isLoading=!1}}onFrameChange(t){!this.trace||t<0||t>=this.trace.frames.length||(this.currentFrameIndex=t,this.renderFrame(t))}renderFrame(t){if(!this.trace||!this.visualizer)return;let i=this.trace.frames[t];this.visualizer.renderFrame(i);let a=document.getElementById("ag-frame-info");a&&(a.innerHTML=`
                <span class="ag-frame-num">Frame ${t+1}/${this.trace.frames.length}</span>
                <span class="ag-frame-line">Line ${i.line}</span>
                <span class="ag-frame-func">${i.function}()</span>
            `),this.highlightLine(i.line)}highlightLine(t){var i,a;if(this.codeEditor&&((i=this.trace)!=null&&i.source_code)){let s=this.trace.source_code.split(`
`),n=0;for(let l=0;l<t-1&&l<s.length;l++)n+=s[l].length+1;this.codeEditor.setSelectionRange(n,n+(((a=s[t-1])==null?void 0:a.length)||0)),this.codeEditor.focus()}}updateStatus(t){this.statusBar&&(this.statusBar.textContent=t)}};var x={apiUrl:"http://localhost:8000",maxSteps:500,playSpeed:500,theme:"auto"},E=class extends d.Plugin{constructor(){super(...arguments);this.settings=x}async onload(){console.log("\u{1F680} AntiGravity Debugger loading..."),await this.loadSettings(),this.registerView(m,t=>new b(t,this)),this.addRibbonIcon("bug","AntiGravity Debugger",()=>{this.activateView()}),this.addCommand({id:"open-antigravity-debugger",name:"Open AntiGravity Debugger",callback:()=>this.activateView()}),this.addCommand({id:"trace-selected-code",name:"Trace Selected C++ Code",editorCallback:t=>{let i=t.getSelection();i&&this.traceCode(i)}}),this.addSettingTab(new S(this.app,this)),console.log("\u2705 AntiGravity Debugger loaded")}onunload(){console.log("\u{1F44B} AntiGravity Debugger unloading...")}async loadSettings(){this.settings=Object.assign({},x,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let{workspace:t}=this.app,i=null,a=t.getLeavesOfType(m);a.length>0?i=a[0]:(i=t.getRightLeaf(!1),i&&await i.setViewState({type:m,active:!0})),i&&t.revealLeaf(i)}async traceCode(t){await this.activateView();let i=this.app.workspace.getLeavesOfType(m);i.length>0&&i[0].view.loadSourceCode(t)}},S=class extends d.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"AntiGravity Debugger Settings"}),new d.Setting(e).setName("Backend API URL").setDesc("URL of the AntiGravity tracer backend").addText(t=>t.setPlaceholder("http://localhost:8000").setValue(this.plugin.settings.apiUrl).onChange(async i=>{this.plugin.settings.apiUrl=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Maximum Steps").setDesc("Maximum number of execution steps to trace").addSlider(t=>t.setLimits(100,2e3,100).setValue(this.plugin.settings.maxSteps).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxSteps=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Auto-play Speed").setDesc("Milliseconds per frame during auto-play").addSlider(t=>t.setLimits(100,2e3,100).setValue(this.plugin.settings.playSpeed).setDynamicTooltip().onChange(async i=>{this.plugin.settings.playSpeed=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Theme").setDesc("Visualization theme").addDropdown(t=>t.addOption("auto","Auto (follow Obsidian)").addOption("dark","Dark").addOption("light","Light").setValue(this.plugin.settings.theme).onChange(async i=>{this.plugin.settings.theme=i,await this.plugin.saveSettings()}))}};
